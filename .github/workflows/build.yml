name: Build Cheat Engine
on: [push, pull_request, workflow_dispatch]

jobs:
  build:
    runs-on: windows-latest
    
    steps:
      - name: Checkout Source
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Lazarus
        uses: gcarreno/setup-lazarus@v3
        with:
          lazarus-version: 'stable'
          with-higher-fpc: true

      - name: Register Dependencies
        run: |
          # We need to register the packages that Cheat Engine relies on
          lazbuild "Cheat Engine/lazcontrols/lazcontrols.lpk"
          # Add any other .lpk files here if you get more "Unit not found" errors

      - name: Build Cheat Engine (64-bit)
        run: |
          cd "Cheat Engine"
          # Use --primary-config-path to ensure it stores package info correctly
          lazbuild --os=win64 --cpu=x86_64 --build-mode=Release --primary-config-path=. cheatengine.lpi

      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Cheat-Engine-Win64
          path: |
            Cheat Engine/bin/*.exe
            Cheat Engine/bin/*.dll
