name: Build Cheat Engine

on:
  push:
  pull_request:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout source
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Lazarus
        uses: gcarreno/setup-lazarus@v3
        with:
          lazarus-version: 'stable'
          with-higher-fpc: true

      - name: Register Dependencies
        shell: pwsh
        run: |
          # We go deep into the directory where the packages actually live
          $root = "cheat-engine/Cheat Engine"
          lazbuild "$root/lazcontrols/lazcontrols.lpk"
          lazbuild "$root/VirtualListView/virtuallistview_package.lpk"
          lazbuild "$root/UnitTreeview/unittreeview_package.lpk"
          lazbuild "$root/LuaEngine/Lua/lua_package.lpk"

      - name: Build Cheat Engine (x64 Release)
        shell: pwsh
        run: |
          # Move to the directory containing the project file
          cd "cheat-engine/Cheat Engine"
          
          # Build the main project
          lazbuild cheatengine.lpi --build-mode=Release --os=win64 --cpu=x86_64 --primary-config-path=../lazarus-config

      - name: Collect Build Artifacts
        shell: pwsh
        run: |
          mkdir final_artifacts
          # The binaries are produced in the 'bin' folder under Cheat Engine
          $binPath = "cheat-engine/Cheat Engine/bin"
          
          if (Test-Path "$binPath/cheatengine-x86_64.exe") {
              Copy-Item "$binPath/*" -Destination "final_artifacts" -Recurse
              Write-Host "Success: Artifacts collected."
          } else {
              Write-Error "Error: Main EXE was not found in $binPath"
              exit 1
          }

      - name: Upload Build
        uses: actions/upload-artifact@v4
        with:
          name: CheatEngine-Binaries
          path: final_artifacts/
