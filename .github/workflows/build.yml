name: Build Cheat Engine
on: [push, pull_request, workflow_dispatch]

jobs:
  build:
    runs-on: windows-latest
    
    steps:
      - name: Checkout Source
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Lazarus
        uses: gcarreno/setup-lazarus@v3
        with:
          lazarus-version: 'stable'
          with-higher-fpc: true

      - name: Register Dependencies
        run: |
          # Navigating into your specific nested folder structure
          $root = "cheat-engine/cheat-engine/Cheat Engine"
          
          # Register all the required packages for Cheat Engine
          lazbuild "$root/lazcontrols/lazcontrols.lpk"
          lazbuild "$root/VirtualListView/virtuallistview_package.lpk"
          lazbuild "$root/UnitTreeview/unittreeview_package.lpk"
          lazbuild "$root/LuaEngine/Lua/lua_package.lpk"

      - name: Build Cheat Engine (64-bit)
        run: |
          # Building the main project
          $projectPath = "cheat-engine/cheat-engine/Cheat Engine/cheatengine.lpi"
          lazbuild --os=win64 --cpu=x86_64 --build-mode=Release --primary-config-path=. "$projectPath"

      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Cheat-Engine-Sylixa-Build
          path: |
            cheat-engine/cheat-engine/Cheat Engine/bin/*.exe
            cheat-engine/cheat-engine/Cheat Engine/bin/*.dll
